---
- name: Add an Apt signing key, uses whichever key is at the URL
  ansible.builtin.apt_key:
    url: https://apt.releases.hashicorp.com/gpg
    state: present

- name: install hashicorp Terraform repository
  apt_repository:
    repo: deb [arch=amd64] https://apt.releases.hashicorp.com focal main
    state: present
  become: true

- name: add Kubernetes apt-key
  apt_key:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    state: present
  register: apt_key_output

- name: add Kubernetes' APT repository
  apt_repository:
    repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
    state: present
    filename: 'kubernetes'
  when: apt_key_output.state is not defined

- name: Create src
  file:
    path: /src
    owner: antonio
    group: antonio
    state: directory

- name: Clone Terraform-KLVM
  become: yes
  become_user: antonio
  ansible.builtin.git:
    repo: https://gitlab.com/ammartins/terraform-kvm.git
    dest: /src/terraform-kvm
    force: yes

- name: Clone Ansible-K8s
  become: yes
  become_user: antonio
  ansible.builtin.git:
    repo: https://gitlab.com/chilicongraphics1/ansible-k8s.git
    dest: /src/ansible-k8s
    force: yes

- name: Clone Terraform-Argo-Apps
  become: yes
  become_user: antonio
  ansible.builtin.git:
    repo: https://gitlab.com/chilicongraphics1/terraform-argo-apps.git
    dest: /src/terraform-argo-apps
    force: yes

- name: Clone Terraform-k8s
  become: yes
  become_user: antonio
  ansible.builtin.git:
    repo: https://gitlab.com/chilicongraphics1/terraform-k8s.git
    dest: /src/terraform-k8s
    force: yes

- name: Install terraform cluster packages
  apt:
    name: "{{ item }}"
    state: "present"
  with_items: "{{ terraform_packages }}"

## TODO: Review This
#- name: Create ssl folder
#  file:
#    path: /var/ssl
#    owner: root
#    group: root
#    state: directory
#
#- name: Create private key (RSA, 4096 bits)
#  community.crypto.openssl_privatekey:
#    path: /var/ssl/certificate.key
#
#- name: Create private key (X25519) with password protection
#  community.crypto.openssl_privatekey:
#    path: /var/ssl/certificate.key
#    size: 2048
#
#- name: Create simple self-signed certificate
#  community.crypto.x509_certificate:
#    path: /var/ssl/certificate.pem
#    privatekey_path: /var/ssl/certificate.key
#    provider: selfsigned
#
#- name: Hack To Setup Need Key File
#  ansible.builtin.copy:
#    src: /var/ssl/certificate.key
#    dest: /var/ssl/certificate.pem.key
#    remote_src: yes

- name: Configure Clusteer Mega
  include_tasks: k8s-cluster-mega.yml
  when: inventory_hostname in groups['k8s-mega']

- name: Configure Clusteer Bulky
  include_tasks: k8s-cluster-bulky.yml
  when: inventory_hostname in groups['k8s-bulky']